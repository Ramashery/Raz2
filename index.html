<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Динамические теги (заполняются скриптом ниже) -->
    <title>Digital Craft | Loading...</title>
    <meta name="description" content="">
    
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Подключаем существующий CSS -->
    <link rel="stylesheet" href="/styles.css">

    <style>
        /* Стили для лоадера */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #030409; display: flex; justify-content: center; align-items: center; 
            z-index: 10000; transition: opacity 0.5s ease-out; 
        }
        .spinner { 
            width: 50px; height: 50px; border: 3px solid #b8d8e8; 
            border-radius: 50%; border-top-color: transparent; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        main { opacity: 0; transition: opacity 0.8s ease-in-out; }
        main.loaded { opacity: 1; }
        
        /* Защита от наложения фона на текст */
        #custom-background-iframe {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            border: none; z-index: 0; display: none; opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }
    </style>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <!-- Экран загрузки -->
    <div id="loader"><div class="spinner"></div></div>
    
    <!-- Фрейм для анимации фона из Firebase -->
    <iframe id="custom-background-iframe" title="Custom Background"></iframe>
    
    <!-- Кнопка меню -->
    <button class="menu-toggle" aria-label="Toggle menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>
    
    <div class="nav-overlay">
        <ul class="nav-menu">
            <li><a href="#hero">Home</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#portfolio">Portfolio</a></li>
            <li><a href="#blog">Blog</a></li>
            <li><a href="#contact">Contact</a></li>
        </ul>
    </div>

    <main id="main-content">
        <!-- HERO СЕКЦИЯ -->
        <section id="hero" class="hero">
            <h1 class="animate-always" id="db-h1">Web Development & SEO</h1>
            <div class="hero-subtitle-container animate-always">
                <p id="db-subtitle">Connecting to razrabotka database...</p>
                <ul class="hero-contact-list">
                    <li><a href="https://wa.me/79119396075" target="_blank">WhatsApp</a></li>
                    <li><a href="https://t.me/ramashery" target="_blank">Telegram</a></li>
                    <li><a href="tel:+995591102653">+995 591 102 653</a></li>
                </ul>
            </div>
        </section>

        <!-- Контейнеры для динамических карточек -->
        <section id="services"></section>
        <section id="portfolio"></section>
        <section id="blog"></section>
        <section id="contact"></section>
    </main>

    <footer class="site-footer">
        © 2025 Digital Craft | <span style="opacity: 0.6">Experimental Hosting (raz2raz2)</span>
    </footer>

    <script type="module">
        // Конфигурация вашего проекта razrabotka-b61bc
        const firebaseConfig = {
            apiKey: "AIzaSyAT4dDEIDUtzP60ibjahO06P75Q6h95ZN4",
            authDomain: "razrabotka-b61bc.firebaseapp.com",
            projectId: "razrabotka-b61bc",
            storageBucket: "razrabotka-b61bc.firebasestorage.app",
            messagingSenderId: "394402564794",
            appId: "1:394402564794:web:f610ffb03e655c600c5083"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function initExperimentalTemplate() {
            try {
                // 1. Загружаем контент главной страницы
                const homeDoc = await db.collection('home').doc('content').get();
                const home = homeDoc.data() || {};

                // Обновляем SEO и заголовок
                document.title = home.seoTitle || "Digital Craft Tbilisi";
                document.querySelector('meta[name="description"]').content = home.metaDescription || "";
                document.getElementById('db-h1').innerText = home.h1 || "Web Development & SEO";
                document.getElementById('db-subtitle').innerText = home.subtitle || "";

                // Применяем кастомный фон
                if (home.backgroundHtml) {
                    const bgIframe = document.getElementById('custom-background-iframe');
                    bgIframe.srcdoc = home.backgroundHtml;
                    bgIframe.style.display = 'block';
                    setTimeout(() => bgIframe.style.opacity = '1', 1000);
                }

                // 2. Загружаем и рендерим карточки для всех секций
                const sections = ['services', 'portfolio', 'blog', 'contact'];
                for (const section of sections) {
                    const snapshot = await db.collection(section).get();
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCards(section, items);
                }

                // 3. Завершаем загрузку
                finishLoading();

            } catch (error) {
                console.error("Database connection failed:", error);
                document.getElementById('db-subtitle').innerText = "Database connection error.";
                finishLoading();
            }
        }

        function renderCards(sectionId, items) {
            const container = document.getElementById(sectionId);
            if (!container || items.length === 0) return;

            // Фильтруем по языку (по умолчанию English)
            const lang = "en";
            const filteredItems = items.filter(item => item.lang === lang);
            if (filteredItems.length === 0) return;

            const sectionTitle = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
            
            const cardsHTML = filteredItems.map(item => `
                <a href="/${lang}/${sectionId}/${item.urlSlug}/" class="item-card animate-on-scroll">
                    <div class="item-card__image" style="background-image: url('${(item.media && item.media[0]) || ''}')"></div>
                    <div class="item-card__content">
                        <h3>${item.title || 'Untitled'}</h3>
                        <div class="card-subtitle">${item.subtitle || ''}</div>
                        <p>${item.description || ''}</p>
                    </div>
                </a>
            `).join('');

            container.innerHTML = `
                <div class="animated-container"><h2>Our ${sectionTitle}</h2></div>
                <div class="item-grid">${cardsHTML}</div>
            `;
        }

        function finishLoading() {
            const loader = document.getElementById('loader');
            const main = document.getElementById('main-content');
            
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
                main.classList.add('loaded');
                initScrollAnimations();
            }, 500);
        }

        function initScrollAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.animate-on-scroll, .animate-always, .animated-container').forEach(el => {
                observer.observe(el);
            });
        }

        // Логика бургер-меню
        const menuBtn = document.querySelector('.menu-toggle');
        const nav = document.querySelector('.nav-overlay');
        
        menuBtn.addEventListener('click', () => {
            document.body.classList.toggle('nav-is-open');
            menuBtn.classList.toggle('is-active');
            nav.classList.toggle('is-active');
        });

        // Закрытие меню при клике на ссылку (якорную)
        document.querySelectorAll('.nav-menu a').forEach(a => {
            a.addEventListener('click', () => {
                document.body.classList.remove('nav-is-open');
                menuBtn.classList.remove('is-active');
                nav.classList.remove('is-active');
            });
        });

        // Запуск инициализации
        window.addEventListener('DOMContentLoaded', initExperimentalTemplate);
    </script>
</body>
</html>
