<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Craft | Experimental Site</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Стили -->
    <link rel="stylesheet" href="/styles.css">

    <style>
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #030409; display: flex; justify-content: center; align-items: center; 
            z-index: 10000; transition: opacity 0.5s ease-out; 
        }
        .spinner { 
            width: 50px; height: 50px; border: 3px solid #b8d8e8; 
            border-radius: 50%; border-top-color: transparent; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        main { opacity: 0; transition: opacity 0.8s ease-in-out; }
        main.loaded { opacity: 1; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>
    
    <iframe id="custom-background-iframe" title="Custom Background" style="display:none;"></iframe>
    
    <button class="menu-toggle" aria-label="Toggle menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>
    
    <div class="nav-overlay">
        <ul class="nav-menu">
            <li><a href="#hero">Home</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#portfolio">Portfolio</a></li>
            <li><a href="#blog">Blog</a></li>
            <li><a href="#contact">Contact</a></li>
        </ul>
    </div>

    <main id="main-content">
        <section id="hero" class="hero">
            <h1 class="animate-always">Web Development & SEO in Tbilisi</h1>
            <div class="hero-subtitle-container animate-always">
                <p>We create high-performance websites for Georgian businesses that attract clients and boost revenue.</p>
                <ul class="hero-contact-list">
                    <li><a href="https://wa.me/79119396075" target="_blank">WhatsApp</a></li>
                    <li><a href="https://t.me/ramashery" target="_blank">Telegram</a></li>
                    <li><a href="tel:+995591102653">+995 591 102 653</a></li>
                </ul>
            </div>
        </section>

        <section id="services"></section>
        <section id="portfolio"></section>
        <section id="blog"></section>
        <section id="contact"></section>
    </main>

    <footer class="site-footer" id="site-footer"></footer>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAT4dDEIDUtzP60ibjahO06P75Q6h95ZN4",
            authDomain: "razrabotka-b61bc.firebaseapp.com",
            projectId: "razrabotka-b61bc",
            storageBucket: "razrabotka-b61bc.firebasestorage.app",
            messagingSenderId: "394402564794",
            appId: "1:394402564794:web:f610ffb03e655c600c5083"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let siteData = {};

        // Вспомогательная функция для HTML разметки (как в вашем main.js)
        function formatContentHtml(content) {
            if (!content) return '';
            let processed = content.replace(/\r\n/g, '\n');
            return processed.split(/\n{2,}/).map(block => {
                const trimmed = block.trim();
                if (/^<(p|div|h[1-6]|ul|ol|li|blockquote|hr|table|pre)/i.test(trimmed)) return trimmed;
                return `<p>${trimmed.replace(/\n/g, '<br>')}</p>`;
            }).join('');
        }

        async function initSite() {
            try {
                const collections = ['services', 'portfolio', 'blog', 'contact'];
                const dataPromises = [
                    db.collection('home').doc('content').get(),
                    ...collections.map(col => db.collection(col).get())
                ];

                const [homeDoc, ...snapshots] = await Promise.all(dataPromises);
                siteData.home = homeDoc.data();
                collections.forEach((col, idx) => {
                    siteData[col] = snapshots[idx].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });

                // Применяем Hero данные и фон
                if (siteData.home) {
                    const heroH1 = document.querySelector('.hero h1');
                    const heroP = document.querySelector('.hero-subtitle-container p');
                    if (siteData.home.h1) heroH1.innerHTML = siteData.home.h1; // Используем innerHTML для разметки
                    if (siteData.home.subtitle) heroP.innerHTML = formatContentHtml(siteData.home.subtitle);

                    if (siteData.home.backgroundHtml) {
                        const iframe = document.getElementById('custom-background-iframe');
                        iframe.srcdoc = siteData.home.backgroundHtml;
                        iframe.style.display = 'block';
                        setTimeout(() => iframe.classList.add('is-visible'), 500);
                    }
                }

                // Рендерим секции с использованием вашей логики каруселей
                collections.forEach(key => renderSectionWithCarousels(key, `Our ${key.charAt(0).toUpperCase() + key.slice(1)}`));

                // Инициализация каруселей (как в вашем основном коде)
                initDesktopCarousels();
                initMobileSliders();

                // Финальный показ страницы
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('main-content').classList.add('loaded');
                    initObservers();
                }, 500);

            } catch (err) { console.error(err); }
        }

        function renderSectionWithCarousels(key, title) {
            const section = document.getElementById(key);
            const items = siteData[key] || [];
            if (!section || items.length === 0) return;

            const langOrder = ['en', 'ka', 'ua', 'ru'];
            const langNames = { en: 'English', ka: 'Georgian', ua: 'Ukrainian', ru: 'Russian' };
            const itemsByLang = {};
            items.forEach(i => { if (!itemsByLang[i.lang]) itemsByLang[i.lang] = []; itemsByLang[i.lang].push(i); });

            // Desktop HTML (Группировка по 3 карточки для слайдера)
            const desktopGridsHTML = langOrder.map(lang => {
                const langItems = itemsByLang[lang];
                if (!langItems) return '';
                const slides = [];
                for (let i = 0; i < langItems.length; i += 3) slides.push(langItems.slice(i, i + 3));

                const slidesHTML = slides.map((slideItems, idx) => {
                    const cards = slideItems.map(item => `
                        <a href="/en/${key}/${item.urlSlug}/" class="item-card">
                            <div class="item-card__image" style="background-image: url('${(item.media || [])[0] || ''}')"></div>
                            <div class="item-card__content">
                                <h3>${item.title}</h3>
                                <div class="card-subtitle">${item.subtitle}</div>
                                <p>${item.description}</p>
                            </div>
                        </a>
                    `).join('');
                    return `<div class="desktop-grid-slide ${idx === 0 ? 'active' : ''}">${cards}</div>`;
                }).join('');

                const dots = slides.length > 1 ? `<div class="desktop-slider-nav">${slides.map((_, i) => `<span class="desktop-slider-dot ${i === 0 ? 'active' : ''}" data-index="${i}"></span>`).join('')}</div>` : '';
                return `<div class="desktop-language-group"><h4 class="desktop-lang-title">${langNames[lang]}</h4><div class="desktop-carousel-container">${slidesHTML}</div>${dots}</div>`;
            }).join('');

            // Mobile HTML (По 1 карточке с Cross-fade)
            const mobileSlidersHTML = langOrder.map(lang => {
                const langItems = itemsByLang[lang];
                if (!langItems) return '';
                const slidesHTML = langItems.map((item, idx) => `
                    <a href="/en/${key}/${item.urlSlug}/" class="item-card ${idx === 0 ? 'active' : ''}">
                        <div class="item-card__image" style="background-image: url('${(item.media || [])[0] || ''}')"></div>
                        <div class="item-card__content">
                            <h3>${item.title}</h3>
                            <div class="card-subtitle">${item.subtitle}</div>
                            <p>${item.description}</p>
                        </div>
                    </a>
                `).join('');
                const dots = langItems.length > 1 ? `<div class="slider-nav">${langItems.map((_, i) => `<span class="slider-dot ${i === 0 ? 'active' : ''}" data-index="${i}"></span>`).join('')}</div>` : '';
                return `<div class="language-slider-block"><div class="cross-fade-slider">${slidesHTML}</div>${dots}</div>`;
            }).join('');

            section.innerHTML = `<div class="animated-container"><h2>${title}</h2></div><div class="desktop-grid-wrapper">${desktopGridsHTML}</div><div class="mobile-sliders-container">${mobileSlidersHTML}</div>`;
        }

        // --- ВАШИ ОРИГИНАЛЬНЫЕ ФУНКЦИИ СЛАЙДЕРОВ ---
        function initDesktopCarousels() {
            document.querySelectorAll('.desktop-carousel-container').forEach(carousel => {
                const slides = carousel.querySelectorAll('.desktop-grid-slide');
                const dots = carousel.parentElement.querySelectorAll('.desktop-slider-dot');
                if (slides.length <= 1) return;
                let cur = 0;
                setInterval(() => {
                    cur = (cur + 1) % slides.length;
                    slides.forEach((s, i) => s.classList.toggle('active', i === cur));
                    dots.forEach((d, i) => d.classList.toggle('active', i === cur));
                }, 7000);
            });
        }

        function initMobileSliders() {
            document.querySelectorAll('.language-slider-block').forEach(block => {
                const slides = block.querySelectorAll('.item-card');
                const dots = block.querySelectorAll('.slider-dot');
                if (slides.length <= 1) return;
                let cur = 0;
                setInterval(() => {
                    cur = (cur + 1) % slides.length;
                    slides.forEach((s, i) => s.classList.toggle('active', i === cur));
                    dots.forEach((d, i) => d.classList.toggle('active', i === cur));
                }, 5000);
            });
        }

        function initObservers() {
            const obs = new IntersectionObserver(es => es.forEach(e => { if(e.isIntersecting) e.target.classList.add('is-visible') }), {threshold: 0.1});
            document.querySelectorAll('.animate-on-scroll, .animate-always, .animated-container, .item-card').forEach(el => obs.observe(el));
        }

        // Меню
        document.querySelector('.menu-toggle').addEventListener('click', () => {
            document.body.classList.toggle('nav-is-open');
            document.querySelector('.menu-toggle').classList.toggle('is-active');
            document.querySelector('.nav-overlay').classList.toggle('is-active');
        });

        window.addEventListener('DOMContentLoaded', initSite);
    </script>
</body>
</html>
