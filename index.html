<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Craft | Experimental Site</title>
    
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Основной CSS проекта -->
    <link rel="stylesheet" href="/styles.css">

    <style>
        /* Стили лоадера */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #030409; display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.5s ease-out; }
        .spinner { width: 50px; height: 50px; border: 3px solid #b8d8e8; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Исправление наложения карточек, если JS еще не скрыл их */
        .cross-fade-slider .item-card:not(.active) { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .desktop-grid-slide:not(.active) { opacity: 0; pointer-events: none; }
        
        main { opacity: 0; transition: opacity 0.6s ease-in-out; }
        main.loaded { opacity: 1; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body data-static-page="false">

    <div id="loader"><div class="spinner"></div></div>
    
    <!-- Фон из Firebase -->
    <iframe id="custom-background-iframe" title="Custom Background" style="display:none;"></iframe>
    
    <!-- Исправленная кнопка меню -->
    <button class="menu-toggle" aria-label="Toggle menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>
    
    <div class="nav-overlay">
        <ul class="nav-menu">
            <li><a href="#hero">Home</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#portfolio">Portfolio</a></li>
            <li><a href="#blog">Blog</a></li>
        </ul>
    </div>

    <main id="main-content">
        <!-- HERO (убрал лишние списки из HTML, они добавятся через JS) -->
        <section id="hero" class="hero">
            <h1 class="animate-always" id="db-h1"></h1>
            <div class="hero-subtitle-container animate-always" id="db-hero-content"></div>
        </section>

        <section id="services"></section>
        <section id="portfolio"></section>
        <section id="blog"></section>
        <section id="contact"></section>
    </main>

    <footer class="site-footer" id="site-footer"></footer>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAT4dDEIDUtzP60ibjahO06P75Q6h95ZN4",
            authDomain: "razrabotka-b61bc.firebaseapp.com",
            projectId: "razrabotka-b61bc",
            storageBucket: "razrabotka-b61bc.firebasestorage.app",
            messagingSenderId: "394402564794",
            appId: "1:394402564794:web:f610ffb03e655c600c5083"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const langOrder = ['en', 'ka', 'ua', 'ru'];
        const langNames = { en: 'English', ka: 'Georgian', ua: 'Ukrainian', ru: 'Russian' };

        async function initSite() {
            try {
                // 1. HERO CONTENT
                const homeDoc = await db.collection('home').doc('content').get();
                const home = homeDoc.data();
                if (home) {
                    document.getElementById('db-h1').innerText = home.h1;
                    document.getElementById('db-hero-content').innerHTML = `
                        <p>${home.subtitle}</p>
                        <ul class="hero-contact-list">
                            <li><a href="https://wa.me/79119396075" target="_blank">WhatsApp</a></li>
                            <li><a href="https://t.me/ramashery" target="_blank">Telegram</a></li>
                            <li><a href="tel:+995591102653">+995 591 102 653</a></li>
                        </ul>
                    `;
                    if (home.backgroundHtml) {
                        const bg = document.getElementById('custom-background-iframe');
                        bg.srcdoc = home.backgroundHtml;
                        bg.style.display = 'block';
                        setTimeout(() => bg.classList.add('is-visible'), 500);
                    }
                }

                // 2. SECTIONS & CARDS
                const cols = ['services', 'portfolio', 'blog', 'contact'];
                for (const col of cols) {
                    const snap = await db.collection(col).get();
                    const items = snap.docs.map(doc => doc.data());
                    renderSection(col, items);
                }

                // 3. INIT JS LOGIC
                initSliders();
                initMenu();
                
                // FINISH LOADING
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('main-content').classList.add('loaded');
                    setupObservers();
                }, 500);

            } catch (err) { console.error(err); }
        }

        function renderSection(key, items) {
            const container = document.getElementById(key);
            if (!container || items.length === 0) return;

            const itemsByLang = {};
            items.forEach(i => { if(!itemsByLang[i.lang]) itemsByLang[i.lang] = []; itemsByLang[i.lang].push(i); });

            // Desktop HTML
            const desktopHTML = langOrder.map(lang => {
                const langItems = itemsByLang[lang];
                if (!langItems) return '';
                const slides = [];
                for (let i = 0; i < langItems.length; i += 3) slides.push(langItems.slice(i, i + 3));

                const slidesHTML = slides.map((slide, idx) => `
                    <div class="desktop-grid-slide ${idx === 0 ? 'active' : ''}">
                        ${slide.map(item => `
                            <a href="/en/${key}/${item.urlSlug}/" class="item-card">
                                <div class="item-card__image" style="background-image: url('${item.media?.[0] || ''}')"></div>
                                <div class="item-card__content">
                                    <h3>${item.title}</h3>
                                    <div class="card-subtitle">${item.subtitle}</div>
                                    <p>${item.description}</p>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                `).join('');

                const dots = slides.length > 1 ? `<div class="desktop-slider-nav">${slides.map((_, i) => `<span class="desktop-slider-dot ${i === 0 ? 'active' : ''}" data-index="${i}"></span>`).join('')}</div>` : '';
                return `<div class="desktop-language-group"><h4 class="desktop-lang-title">${langNames[lang]}</h4><div class="desktop-carousel-container">${slidesHTML}</div>${dots}</div>`;
            }).join('');

            // Mobile HTML
            const mobileHTML = langOrder.map(lang => {
                const langItems = itemsByLang[lang];
                if (!langItems) return '';
                const slidesHTML = langItems.map((item, idx) => `
                    <div class="item-card ${idx === 0 ? 'active' : ''}">
                        <div class="item-card__image" style="background-image: url('${item.media?.[0] || ''}')"></div>
                        <div class="item-card__content">
                            <h3>${item.title}</h3>
                            <div class="card-subtitle">${item.subtitle}</div>
                            <p>${item.description}</p>
                        </div>
                    </div>
                `).join('');
                const dots = langItems.length > 1 ? `<div class="slider-nav">${langItems.map((_, i) => `<span class="slider-dot ${i === 0 ? 'active' : ''}" data-index="${i}"></span>`).join('')}</div>` : '';
                return `<div class="language-slider-block"><div class="cross-fade-slider">${slidesHTML}</div>${dots}</div>`;
            }).join('');

            container.innerHTML = `<div class="animated-container"><h2>Our ${key}</h2></div><div class="desktop-grid-wrapper">${desktopHTML}</div><div class="mobile-sliders-container">${mobileHTML}</div>`;
        }

        function initSliders() {
            // Desktop Carousels
            document.querySelectorAll('.desktop-carousel-container').forEach(c => {
                const slides = c.querySelectorAll('.desktop-grid-slide');
                const dots = c.parentElement.querySelectorAll('.desktop-slider-dot');
                dots.forEach(dot => {
                    dot.onclick = () => {
                        const i = parseInt(dot.dataset.index);
                        slides.forEach((s, idx) => s.classList.toggle('active', idx === i));
                        dots.forEach((d, idx) => d.classList.toggle('active', idx === i));
                    };
                });
            });

            // Mobile Sliders
            document.querySelectorAll('.language-slider-block').forEach(b => {
                const slides = b.querySelectorAll('.item-card');
                const dots = b.querySelectorAll('.slider-dot');
                dots.forEach(dot => {
                    dot.onclick = () => {
                        const i = parseInt(dot.dataset.index);
                        slides.forEach((s, idx) => s.classList.toggle('active', idx === i));
                        dots.forEach((d, idx) => d.classList.toggle('active', idx === i));
                    };
                });
            });
        }

        function initMenu() {
            const btn = document.querySelector('.menu-toggle');
            const nav = document.querySelector('.nav-overlay');
            btn.onclick = () => {
                document.body.classList.toggle('nav-is-open');
                btn.classList.toggle('is-active');
                nav.classList.toggle('is-active');
            };
            document.querySelectorAll('.nav-menu a').forEach(a => {
                a.onclick = () => {
                    document.body.classList.remove('nav-is-open');
                    btn.classList.remove('is-active');
                    nav.classList.remove('is-active');
                };
            });
        }

        function setupObservers() {
            const obs = new IntersectionObserver(es => {
                es.forEach(e => { if(e.isIntersecting) e.target.classList.add('is-visible'); });
            }, { threshold: 0.1 });
            document.querySelectorAll('.animate-on-scroll, .animate-always, .animated-container, .item-card').forEach(el => obs.observe(el));
        }

        window.addEventListener('DOMContentLoaded', initSite);
    </script>
</body>
</html>
